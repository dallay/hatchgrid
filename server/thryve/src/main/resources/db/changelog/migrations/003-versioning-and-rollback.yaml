databaseChangeLog:
  - changeSet:
      id: 003-versioning
      author: hatchgrid
      comment: Add database versioning table

      changes:
        # Database version table
        - createTable:
            tableName: database_version
            columns:
              - column:
                  name: id
                  type: int
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: version
                  type: varchar(50)
                  constraints:
                    unique: true
                    nullable: false
              - column:
                  name: description
                  type: varchar(255)
              - column:
                  name: installed_by
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: installed_on
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: success
                  type: boolean
                  defaultValueBoolean: true
                  constraints:
                    nullable: false

        # Insert initial version
        - insert:
            tableName: database_version
            columns:
              - column:
                  name: version
                  value: 1.0.0
              - column:
                  name: description
                  value: Initial database schema
              - column:
                  name: installed_by
                  value: system

      rollback:
        - dropTable:
            tableName: database_version

  - changeSet:
      id: 003-rollback-procedures
      author: hatchgrid
      comment: Define rollback procedures for previous migrations

      changes:
        # Create a function to handle rollbacks
        - sql:
            sql: >
              CREATE OR REPLACE FUNCTION rollback_to_version(target_version VARCHAR) RETURNS VOID AS '
              DECLARE
                  current_version VARCHAR;
              BEGIN
                  SELECT version INTO current_version FROM database_version ORDER BY id DESC LIMIT 1;
                  INSERT INTO database_version (version, description, installed_by, success)
                  VALUES (current_version || '' -> '' || target_version, ''Rollback from '' || current_version || '' to '' || target_version, current_user, true);
              EXCEPTION WHEN OTHERS THEN
                  INSERT INTO database_version (version, description, installed_by, success)
                  VALUES (current_version || '' -> '' || target_version, ''Failed rollback: '' || SQLERRM, current_user, false);
                  RAISE;
              END;
              ' LANGUAGE plpgsql;

      rollback:
        - sql:
            sql: DROP FUNCTION IF EXISTS rollback_to_version(VARCHAR);
